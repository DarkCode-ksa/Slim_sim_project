#!/bin/bash
set -euo pipefail

# === ألوان ===
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

log()    { echo -e "${BLUE}[INFO] $1${NC}"; }
success(){ echo -e "${GREEN}تم: $1${NC}"; }
error()  { echo -e "${RED}خطأ: $1${NC}"; exit 1; }

log "بدء تثبيت SLiM..."

# === 1. التحقق من الأدوات ===
check_tool() {
    local tool="$1"
    local alt="${2:-}"
    if command -v "$tool" &> /dev/null; then return 0; fi
    if [[ -n "$alt" ]] && command -v "$alt" &> /dev/null; then
        log "تم العثور على: $alt"
        return 0
    fi
    error "الأداة '$tool' مفقودة!"
}

check_tool git
check_tool cmake
check_tool g++ c++
check_tool make

# === 2. بناء SLiM ===
SLIM_DIR="$HOME/SLiM"
SLIM_BIN="$HOME/.local/bin/slim"
mkdir -p "$HOME/.local/bin"

if [ -f "$SLIM_BIN" ] && "$SLIM_BIN" -version &> /dev/null; then
    success "SLiM موجود: $($SLIM_BIN -version | head -n1)"
else
    log "استنساخ SLiM..."
    rm -rf "$SLIM_DIR"
    git clone --depth 1 https://github.com/MesserLab/SLiM.git "$SLIM_DIR"

    cd "$SLIM_DIR"
    mkdir -p build && cd build

    log "تشغيل cmake مع مسارات GSL و Eigen..."
    cmake .. \
      -DCMAKE_BUILD_TYPE=Release \
      -DGSL_ROOT_DIR=$CONDA_PREFIX \
      -DEIGEN3_INCLUDE_DIR=$CONDA_PREFIX/include/eigen3 \
      || error "فشل cmake: تأكد من gsl و eigen"

    log "تشغيل make..."
    make -j$(nproc) || error "فشل make"

    log "نسخ slim..."
    cp slim "$SLIM_BIN" || error "فشل النسخ"

    success "تم بناء SLiM: $($SLIM_BIN -version | head -n1)"
fi

# === 3. PATH ===
export PATH="$HOME/.local/bin:$PATH"
echo 'export PATH="$HOME/.local/bin:$PATH"' >> "$HOME/.bashrc"

# === 4. pip ===
log "تثبيت pyslim و msprime..."
pip install --no-cache-dir pyslim msprime

# === 5. مثال ===
EXAMPLE_DIR="$HOME/examples"
mkdir -p "$EXAMPLE_DIR"
cat > "$EXAMPLE_DIR/simple.slim" << 'EOF'
initialize() {
    initializeMutationType("m1", 0.5, "f", -0.1);
    initializeGenomicElementType("g1", m1, 1.0);
    initializeGenomicElement(g1, 0, 9999);
    initializeRecombinationRate(1e-8);
}
1 { sim.addSubpop("p1", 500); }
1000 late() {
    cat("تم بنجاح! التنوع: " + p1.meanHeterozygosity() + "\n");
    sim.outputFull("output.trees");
}
EOF

success "مثال جاهز: $EXAMPLE_DIR/simple.slim"

# === 6. اختبار ===
log "اختبار SLiM..."
if slim "$EXAMPLE_DIR/simple.slim" | grep -q "تم بنجاح"; then
    success "نجح كل شيء! جرب: slim $EXAMPLE_DIR/simple.slim"
else
    error "فشل الاختبار!"
fi
