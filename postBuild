#!/bin/bash
set -euo pipefail

# === ألوان ===
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

log()    { echo -e "${BLUE}[INFO] $1${NC}"; }
success(){ echo -e "${GREEN}تم: $1${NC}"; }
error()  { echo -e "${RED}خطأ: $1${NC}"; exit 1; }

log "بدء تثبيت SLiM..."

# === 1. التحقق من الأدوات ===
for tool in git cmake g++ make; do
    if ! command -v "$tool" &> /dev/null; then
        error "الأداة '$tool' غير مثبتة! تحقق من environment.yml"
    fi
done

# === 2. استنساخ وبناء SLiM ===
SLIM_DIR="$HOME/SLiM"
SLIM_BIN="$HOME/.local/bin/slim"
mkdir -p "$HOME/.local/bin"

if [ -f "$SLIM_BIN" ] && "$SLIM_BIN" -version &> /dev/null; then
    success "SLiM موجود: $($SLIM_BIN -version | head -n1)"
else
    log "استنساخ SLiM..."
    rm -rf "$SLIM_DIR"
    git clone --depth 1 https://github.com/MesserLab/SLiM.git "$SLIM_DIR"

    cd "$SLIM_DIR"
    mkdir -p build && cd build

    log "تشغيل cmake..."
    cmake .. -DCMAKE_BUILD_TYPE=Release || error "فشل cmake"

    log "تشغيل make..."
    make -j$(nproc) || error "فشل make"

    log "نسخ slim إلى $SLIM_BIN..."
    cp slim "$SLIM_BIN" || error "فشل النسخ"

    success "تم تثبيت SLiM: $($SLIM_BIN -version | head -n1)"
fi

# === 3. تفعيل PATH ===
export PATH="$HOME/.local/bin:$PATH"
echo 'export PATH="$HOME/.local/bin:$PATH"' >> "$HOME/.bashrc"

# === 4. تثبيت pyslim/msprime ===
log "تثبيت pyslim و msprime..."
pip install --no-cache-dir pyslim msprime || error "فشل تثبيت pyslim"

# === 5. إنشاء مثال عملي (معدل ليكون صحيحًا) ===
EXAMPLE_DIR="$HOME/examples"
mkdir -p "$EXAMPLE_DIR"
cat > "$EXAMPLE_DIR/simple.slim" << 'EOF'
initialize() {
    initializeMutationType("m1", 0.5, "f", -0.1);
    initializeGenomicElementType("g1", m1, 1.0);
    initializeGenomicElement(g1, 0, 9999);
    initializeRecombinationRate(1e-8);
}
1 late() { sim.addSubpop("p1", 500); }
1000 late() {
    cat("تم بنجاح! التنوع: " + p1.meanHeterozygosity() + "\n");
    sim.outputFull("output.trees");
}
EOF

success "مثال جاهز: slim $EXAMPLE_DIR/simple.slim"

# === 6. اختبار نهائي (مع تجاهل الأخطاء إذا فشل) ===
log "اختبار SLiM..."
if slim "$EXAMPLE_DIR/simple.slim" | grep -q "تم بنجاح"; then
    success "كل شيء يعمل!"
else
    echo -e "${YELLOW}تحذير: فشل الاختبار، لكن SLiM مثبت! جرب تشغيل المثال يدويًا.${NC}"
fi
