#!/bin/bash
set -euo pipefail

# === ألوان ===
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log()    { echo -e "${BLUE}[INFO] $1${NC}"; }
success(){ echo -e "${GREEN}تم بنجاح: $1${NC}"; }
error()  { echo -e "${RED}خطأ: $1${NC}"; exit 1; }

log "بدء تثبيت الأدوات الأساسية عبر apt..."

# تثبيت cmake وأدوات البناء عبر apt (قبل conda)
apt-get update -qq > /dev/null
apt-get install -y -qq cmake g++ make git wget > /dev/null || error "فشل تثبيت cmake عبر apt"

success "تم تثبيت cmake, g++, make, git"

# === تثبيت SLiM ===
SLIM_DIR="$HOME/SLiM"
BIN_DIR="/usr/local/bin"
SLIM_BIN="$BIN_DIR/slim"

log "استنساخ SLiM..."
rm -rf "$SLIM_DIR"
git clone --depth 1 https://github.com/MesserLab/SLiM.git "$SLIM_DIR" || error "فشل الاستنساخ"

cd "$SLIM_DIR"
mkdir -p build && cd build

log "تشغيل cmake..."
cmake .. -DCMAKE_BUILD_TYPE=Release || error "فشل cmake"

log "تشغيل make..."
make -j$(nproc) || error "فشل make"

log "تثبيت slim..."
cp slim "$SLIM_BIN" || error "فشل النسخ"

success "تم تثبيت SLiM: $(slim -version | head -n1)"

# === تثبيت pyslim ===
log "تثبيت pyslim عبر pip..."
pip install --no-cache-dir pyslim msprime || warn "فشل pip"

# === إنشاء مثال ===
mkdir -p ~/examples
cat > ~/examples/test.slim << 'EOF'
initialize() {
    initializeMutationType("m1", 0.5, "f", -0.1);
    initializeGenomicElementType("g1", m1, 1.0
cd ../../
rm -rf SLiM-4.2 SLiM-4.2.tar.gz

# اختبار التثبيت
echo "اختبار SLiM..."
slim -version || { echo "فشل تشغيل SLiM"; exit 1; }

echo "تم تثبيت SLiM بنجاح!"
